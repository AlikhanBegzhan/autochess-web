<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta th:replace="fragments/layout :: meta"/>
    <title>Autochess | Board Test</title>
    <style th:replace="fragments/layout :: style"></style>
    <style>
        [v-cloak] {display: none}
        table#chess-board {
            margin: auto;
            background: white;
            border: 25px solid #333;
            border-collapse: collapse;
        }
        td.chess-board-cell {
            width: 70px; height: 70px;
            border: 2px solid #333;
            font-size: 36px;
            text-align: center;
            cursor: default;
        }
        tr.chess-board-row:nth-child(odd) td.chess-board-cell:nth-child(even),
        tr.chess-board-row:nth-child(even) td.chess-board-cell:nth-child(odd) {
            background: #999;
        }
    </style>
</head>
<body>
<main class="container-fluid">
    <div id="app" class="container-fluid" v-cloak>
        <div class="row">
            <table id="chess-board">
                <tr class="chess-board-row" id="8">
                    <td class="chess-board-cell 0"></td>
                    <td class="chess-board-cell 1"></td>
                    <td class="chess-board-cell 2"></td>
                    <td class="chess-board-cell 3"></td>
                    <td class="chess-board-cell 4"></td>
                    <td class="chess-board-cell 5"></td>
                    <td class="chess-board-cell 6"></td>
                    <td class="chess-board-cell 7"></td>
                </tr>
                <tr class="chess-board-row" id="7">
                    <td class="chess-board-cell 8"></td>
                    <td class="chess-board-cell 9"></td>
                    <td class="chess-board-cell 10"></td>
                    <td class="chess-board-cell 11"></td>
                    <td class="chess-board-cell 12"></td>
                    <td class="chess-board-cell 13"></td>
                    <td class="chess-board-cell 14"></td>
                    <td class="chess-board-cell 15"></td>
                </tr>
                <tr class="chess-board-row" id="6">
                    <td class="chess-board-cell 16"></td>
                    <td class="chess-board-cell 17"></td>
                    <td class="chess-board-cell 18"></td>
                    <td class="chess-board-cell 19"></td>
                    <td class="chess-board-cell 20"></td>
                    <td class="chess-board-cell 21"></td>
                    <td class="chess-board-cell 22"></td>
                    <td class="chess-board-cell 23"></td>
                </tr>

                <tr class="chess-board-row" id="5">
                    <td class="chess-board-cell 24"></td>
                    <td class="chess-board-cell 25"></td>
                    <td class="chess-board-cell 26"></td>
                    <td class="chess-board-cell 27"></td>
                    <td class="chess-board-cell 28"></td>
                    <td class="chess-board-cell 29"></td>
                    <td class="chess-board-cell 30"></td>
                    <td class="chess-board-cell 31"></td>
                </tr>

                <tr class="chess-board-row" id="4">
                    <td class="chess-board-cell 32"></td>
                    <td class="chess-board-cell 33"></td>
                    <td class="chess-board-cell 34"></td>
                    <td class="chess-board-cell 35"></td>
                    <td class="chess-board-cell 36"></td>
                    <td class="chess-board-cell 37"></td>
                    <td class="chess-board-cell 38"></td>
                    <td class="chess-board-cell 39"></td>
                </tr>

                <tr class="chess-board-row" id="3">
                    <td class="chess-board-cell 40"></td>
                    <td class="chess-board-cell 41"></td>
                    <td class="chess-board-cell 42"></td>
                    <td class="chess-board-cell 43"></td>
                    <td class="chess-board-cell 44"></td>
                    <td class="chess-board-cell 45"></td>
                    <td class="chess-board-cell 46"></td>
                    <td class="chess-board-cell 47"></td>
                </tr>

                <tr class="chess-board-row" id="2">
                    <td class="chess-board-cell 48"></td>
                    <td class="chess-board-cell 49"></td>
                    <td class="chess-board-cell 50"></td>
                    <td class="chess-board-cell 51"></td>
                    <td class="chess-board-cell 52"></td>
                    <td class="chess-board-cell 53"></td>
                    <td class="chess-board-cell 54"></td>
                    <td class="chess-board-cell 55"></td>
                </tr>

                <tr class="chess-board-row" id="1">
                    <td class="chess-board-cell 56"></td>
                    <td class="chess-board-cell 57"></td>
                    <td class="chess-board-cell 58"></td>
                    <td class="chess-board-cell 59"></td>
                    <td class="chess-board-cell 60"></td>
                    <td class="chess-board-cell 61"></td>
                    <td class="chess-board-cell 62"></td>
                    <td class="chess-board-cell 63"></td>
                </tr>
            </table>
        </div>
    </div>
</main>

<script th:replace="fragments/layout :: scripts"></script>
<script th:inline="javascript">
    /*<![CDATA[*/
    var app = new Vue({
        el: '#app',
        data: {
            fen: '',
            fenHistory: [],
            cells: [],
            piecesMap: {
                "k": { key: 'k', name: "KING",   color: "WHITE", char: "&#9812;"},
                "q": { key: 'q', name: "QUEEN",  color: "WHITE", char: "&#9813;"},
                "r": { key: 'r', name: "ROOK",   color: "WHITE", char: "&#9814;"},
                "b": { key: 'b', name: "BISHOP", color: "WHITE", char: "&#9815;"},
                "n": { key: 'n', name: "KNIGHT", color: "WHITE", char: "&#9816;"},
                "p": { key: 'p', name: "PAWN",   color: "WHITE", char: "&#9817;"},
                "K": { key: 'K', name: "KING",   color: "BLACK", char: "&#9818;"},
                "Q": { key: 'Q', name: "QUEEN",  color: "BLACK", char: "&#9819;"},
                "R": { key: 'R', name: "ROOK",   color: "BLACK", char: "&#9820;"},
                "B": { key: 'B', name: "BISHOP", color: "BLACK", char: "&#9821;"},
                "N": { key: 'N', name: "KNIGHT", color: "BLACK", char: "&#9822;"},
                "P": { key: 'P', name: "PAWN",   color: "BLACK", char: "&#9823;"}
            }
        },
        watch: {
            fen: function (newFen, oldFen) {
                this.applyFen(newFen);
                this.fenHistory.push(oldFen);
            }
        },
        methods: {
            applyFen: function(fen) {
                console.log('Redraw board: ' + fen);
                var pos = 0;
                for (var i = 0; pos < 64; i++) {
                    var symbol = fen[i];
                    if (/^\d+$/.test(symbol)) {
                        pos += parseInt(symbol);
                    } else if (/^[rnbqkpRNBQKP]+$/.test(symbol)) {
                        var piece = this.piecesMap[symbol];
                        this.cells[pos].html(piece.char);
                        pos++;
                    }
                }
            },
            connect: function() {
                var gameSocketUrl = /*[[ @{/topic/test} ]]*/;

                var ctx = this;
                var socket = new SockJS(/*[[ @{/ws} ]]*/);
                stompClient = Stomp.over(socket);
                stompClient.connect({}, function (frame) {
                    console.log('Connected: ' + frame);
                    stompClient.subscribe(gameSocketUrl, function (message) {
                        ctx.fen = message.body;
                    });
                });
            }
        },
        mounted: function() {
            for (var i = 0; i < 64; i++) {
                this.cells[i] = $('td.chess-board-cell.' + i);
            }
            // this.fen = 'rnbq1bnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQ1BNR';
            this.connect();
        }
    });
    /*]]>*/
</script>
</body>
</html>
